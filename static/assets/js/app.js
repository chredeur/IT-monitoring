class ITMonitoring{constructor(){this.feeds=[],this.categoryMap={},this.filters=this.loadFilters(),this.readArticles=this.loadReadArticles(),this.lastSeenIds=this.loadLastSeenIds(),this.loading=!1,this.newCount=0,this.init()}loadFilters(){const e=localStorage.getItem("itm_filters");return e?JSON.parse(e):{categories:[],types:["announcements","releases"]}}saveFilters(){localStorage.setItem("itm_filters",JSON.stringify(this.filters))}loadReadArticles(){const e=localStorage.getItem("itm_read");return e?JSON.parse(e):[]}saveReadArticles(){const e=this.readArticles.slice(-1e3);localStorage.setItem("itm_read",JSON.stringify(e))}loadLastSeenIds(){const e=localStorage.getItem("itm_last_seen");return e?JSON.parse(e):[]}saveLastSeenIds(){const e=this.feeds.slice(0,100).map(e=>e.id);localStorage.setItem("itm_last_seen",JSON.stringify(e))}isArticleRead(e){return this.readArticles.includes(e)}markAsRead(e){this.readArticles.includes(e)||(this.readArticles.push(e),this.saveReadArticles())}markAllAsRead(){this.getFilteredFeeds().forEach(e=>{this.readArticles.includes(e.id)||this.readArticles.push(e.id)}),this.saveReadArticles(),this.render(),this.updateNewCount()}async init(){this.bindEvents(),await this.loadInitialData(),this.checkUrlArticle()}checkUrlArticle(){const e=new URLSearchParams(window.location.search).get("article");e&&setTimeout(()=>{const t=document.querySelector(`.feed-item[data-id="${CSS.escape(e)}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{t.classList.add("expanded","read"),this.markAsRead(e),t.querySelector(".tag-new")?.remove(),this.updateNewCount(),t.style.boxShadow="0 0 0 2px var(--accent), 0 0 20px rgba(88, 166, 255, 0.4)",setTimeout(()=>{t.style.boxShadow=""},2e3)},500)),window.history.replaceState({},"",window.location.pathname)},300)}bindEvents(){document.getElementById("refresh-btn").addEventListener("click",()=>this.refresh()),document.getElementById("mark-all-read")?.addEventListener("click",()=>this.markAllAsRead()),document.addEventListener("change",e=>{"checkbox"===e.target.type&&this.handleFilterChange(e.target)})}async loadInitialData(){try{await Promise.all([this.loadStats(),this.loadCategories(),this.loadAllFeeds()]),this.setStatus(!0),this.checkNewArticles()}catch(e){console.error("Error loading data:",e),this.setStatus(!1),this.showToast("Erreur de chargement","error")}}async loadStats(){const e=await fetch("/api/feeds/status"),t=await e.json();if(t.success){const e=t.status;document.getElementById("stat-categories").textContent=e.total_categories,document.getElementById("stat-feeds").textContent=e.total_feeds,document.getElementById("stat-entries").textContent=e.total_entries,document.getElementById("stat-update").textContent=this.formatDateShort(e.last_update)}}async loadCategories(){const e=await fetch("/api/feeds/categories"),t=await e.json();if(t.success){const e=document.getElementById("category-filters");e.innerHTML="",this.categoryMap={};const s=this.filters.categories,a=Object.keys(t.categories);0===s.length&&(this.filters.categories=a),Object.entries(t.categories).forEach(([t,s])=>{this.categoryMap[t]=s.name;const a=this.filters.categories.includes(t),i=document.createElement("label");i.innerHTML=`<input type="checkbox" name="category" value="${t}" ${a?"checked":""}> ${s.name}`,e.appendChild(i)}),document.querySelectorAll('#type-filters input[type="checkbox"]').forEach(e=>{e.checked=this.filters.types.includes(e.value)})}}async loadAllFeeds(){if(!this.loading){this.loading=!0;try{const e=await fetch("/api/feeds/latest?limit=500"),t=await e.json();t.success&&(this.feeds=t.entries,this.render())}catch(e){console.error("Error loading feeds:",e)}finally{this.loading=!1}}}checkNewArticles(){const e=this.feeds.slice(0,100).map(e=>e.id).filter(e=>!this.lastSeenIds.includes(e)&&!this.isArticleRead(e));this.newCount=e.length,this.updateNewCount(),this.saveLastSeenIds()}updateNewCount(){const e=this.getFilteredFeeds().filter(e=>!this.isArticleRead(e.id)).length,t=document.getElementById("new-count");t&&(e>0?(t.textContent=e,t.style.display="inline-flex"):t.style.display="none"),document.title=e>0?`(${e}) IT Monitoring`:"IT Monitoring"}render(){const e=document.getElementById("feed-container"),t=this.getFilteredFeeds();0!==t.length?(e.innerHTML=t.map((e,t)=>this.renderFeedItem(e,t)).join(""),e.querySelectorAll(".feed-item").forEach((e,t)=>{e.style.animationDelay=.03*t+"s"}),e.querySelectorAll(".feed-item").forEach(e=>{e.addEventListener("click",t=>{if(t.target.closest("a"))return;const s=e.dataset.id;this.markAsRead(s),e.classList.add("read"),e.querySelector(".tag-new")?.remove(),e.classList.toggle("expanded"),this.updateNewCount()})}),this.updateNewCount()):e.innerHTML='\n                <div class="empty-state">\n                    <i class="fas fa-inbox"></i>\n                    <p>Aucun article trouvé</p>\n                </div>\n            '}renderFeedItem(e,t){const s=this.formatDate(e.published),a=this.isArticleRead(e.id),i=this.getTypeIcon(e.feed_type);return`\n            <article class="feed-item ${a?"read":""}" data-index="${t}" data-id="${e.id}">\n                <div class="feed-item-header">\n                    <div class="feed-item-tags">\n                        <span class="tag tag-category">\n                            <i class="fas fa-folder"></i>\n                            ${this.escapeHtml(e.category)}\n                        </span>\n                        <span class="tag tag-type ${e.feed_type}">\n                            <i class="${i}"></i>\n                            ${this.getTypeLabel(e.feed_type)}\n                        </span>\n                        ${a?"":'<span class="tag tag-new"><i class="fas fa-sparkles"></i> Nouveau</span>'}\n                    </div>\n                    <span class="feed-item-date">\n                        <i class="far fa-clock"></i>\n                        ${s}\n                    </span>\n                </div>\n                <h3 class="feed-item-title">\n                    <a href="${this.escapeHtml(e.link)}" target="_blank" rel="noopener">\n                        ${this.escapeHtml(e.title)}\n                        <i class="fas fa-external-link-alt"></i>\n                    </a>\n                </h3>\n                <p class="feed-item-preview">${this.getPreview(e.summary)}</p>\n                <div class="feed-item-content">\n                    <div class="feed-item-body">\n                        ${e.summary||"<p>Pas de contenu disponible.</p>"}\n                    </div>\n                </div>\n                <div class="feed-item-footer">\n                    <span class="feed-source">\n                        <i class="fas fa-rss"></i>\n                        ${this.escapeHtml(e.feed_name)}\n                    </span>\n                    ${e.author?`<span class="feed-author"><i class="fas fa-user"></i>${this.escapeHtml(e.author)}</span>`:""}\n                    <span class="feed-item-expand">\n                        <i class="fas fa-chevron-down"></i>\n                        <span class="expand-text">Détails</span>\n                    </span>\n                </div>\n            </article>\n        `}getFilteredFeeds(){return this.feeds.filter(e=>{if(this.filters.categories.length>0){const t=e.category_key||this.getCategoryKeyByName(e.category);if(!this.filters.categories.includes(t))return!1}return 0!==this.filters.types.length&&!!this.filters.types.includes(e.feed_type)})}getCategoryKeyByName(e){for(const[t,s]of Object.entries(this.categoryMap))if(s===e)return t;return e.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"")}handleFilterChange(e){const{name:t,value:s,checked:a}=e;"category"===t?a?this.filters.categories.includes(s)||this.filters.categories.push(s):this.filters.categories=this.filters.categories.filter(e=>e!==s):"type"===t&&(a?this.filters.types.includes(s)||this.filters.types.push(s):this.filters.types=this.filters.types.filter(e=>e!==s)),this.saveFilters(),this.render()}async refresh(){const e=document.getElementById("refresh-btn");e.classList.add("loading");try{this.feeds=[],await this.loadAllFeeds(),await this.loadStats(),this.checkNewArticles(),this.showToast("Données actualisées","success")}catch(t){console.error("Refresh error:",t)}finally{e.classList.remove("loading")}}setStatus(e){const t=document.getElementById("status");e?(t.classList.remove("offline"),t.innerHTML='<i class="fas fa-circle"></i> Connecté'):(t.classList.add("offline"),t.innerHTML='<i class="fas fa-circle"></i> Déconnecté')}showToast(e,t="info"){const s=document.querySelector(".toast");s&&s.remove();const a=document.createElement("div");a.className=`toast ${t}`,a.innerHTML=`\n            <i class="fas fa-${"success"===t?"check-circle":"exclamation-circle"}"></i>\n            <span>${e}</span>\n        `,document.body.appendChild(a),requestAnimationFrame(()=>a.classList.add("show")),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)},3e3)}formatDate(e){if(!e)return"-";const t=new Date(e);if(isNaN(t.getTime()))return e;const s=new Date-t,a=Math.floor(s/6e4),i=Math.floor(s/36e5),n=Math.floor(s/864e5);return a<60?`Il y a ${a}min`:i<24?`Il y a ${i}h`:n<7?`Il y a ${n}j`:t.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}formatDateShort(e){if(!e)return"-";const t=new Date(e);return isNaN(t.getTime())?"-":t.toLocaleDateString("fr-FR",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})}getTypeLabel(e){return{announcements:"Annonce",releases:"Release",commits:"Commit"}[e]||e}getTypeIcon(e){return{announcements:"fas fa-bullhorn",releases:"fas fa-tag",commits:"fas fa-code-commit"}[e]||"fas fa-rss"}getPreview(e){if(!e)return"";const t=document.createElement("div");t.innerHTML=e;const s=t.textContent||t.innerText||"",a=s.trim().substring(0,150);return s.length>150?a+"...":a}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}}document.addEventListener("DOMContentLoaded",()=>{window.app=new ITMonitoring}),setInterval(()=>{window.app&&!window.app.loading&&window.app.refresh()},3e5);